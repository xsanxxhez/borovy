<template>
  <div class="modal-overlay" @click="closeModal">
    <div class="modal-content large" @click.stop>
      <div class="modal-header">
        <h2>üèóÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–í–∞—Ö—Ç—ã)</h2>
        <button @click="closeModal" class="close-btn">‚úï</button>
      </div>

      <div class="modal-tabs">
        <button
          :class="['tab-button', { active: activeTab === 'enterprise' }]"
          @click="activeTab = 'enterprise'"
        >
          üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏
        </button>
        <button
          :class="['tab-button', { active: activeTab === 'specialties' }]"
          @click="activeTab = 'specialties'"
        >
          üë∑ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
          <span class="tab-count">{{ specialties.length }}</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- –í–∫–ª–∞–¥–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–∏ -->
        <div v-if="activeTab === 'enterprise'" class="tab-content">
          <form class="enterprise-form">
            <div class="form-section">
              <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è *</label>
                  <input
                    v-model="enterpriseForm.title"
                    type="text"
                    required
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–ª–∞–¥—Å–∫–æ–π –∫–æ–º–ø–ª–µ–∫—Å ‚Ññ5"
                    class="form-input"
                  >
                </div>

                <div class="form-group full-width">
                  <label>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</label>
                  <textarea
                    v-model="enterpriseForm.description"
                    rows="3"
                    placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, —É—Å–ª–æ–≤–∏–π —Ä–∞–±–æ—Ç—ã..."
                    class="form-input"
                  ></textarea>
                </div>

                <div class="form-group full-width">
                  <label>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ *</label>
                  <input
                    v-model="enterpriseForm.location"
                    type="text"
                    required
                    placeholder="–ì–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã"
                    class="form-input"
                  >
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3>–ü–µ—Ä–∏–æ–¥ —Ä–∞–±–æ—Ç—ã</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                  <input
                    v-model="enterpriseForm.start_date"
                    type="date"
                    required
                    class="form-input"
                  >
                </div>

                <div class="form-group">
                  <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                  <input
                    v-model="enterpriseForm.end_date"
                    type="date"
                    required
                    class="form-input"
                  >
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3>–û–±—â–∏–µ —É—Å–ª–æ–≤–∏—è</h3>
              <div class="form-grid">
                <div class="form-group full-width">
                  <label>–£—Å–ª–æ–≤–∏—è –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –∏ –ø–∏—Ç–∞–Ω–∏—è</label>
                  <textarea
                    v-model="enterpriseForm.conditions"
                    rows="2"
                    placeholder="–û–±—â–µ–∂–∏—Ç–∏–µ, –ø–∏—Ç–∞–Ω–∏–µ, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ —Ç.–¥."
                    class="form-input"
                  ></textarea>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π -->
        <div v-if="activeTab === 'specialties'" class="tab-content">
          <div class="specialties-header">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º–∏</h3>
            <button @click="addSpecialty" class="btn btn-primary btn-sm">
              ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å
            </button>
          </div>

          <div class="specialties-list">
            <div
              v-for="(specialty, index) in specialties"
              :key="index"
              class="specialty-card"
            >
              <div class="specialty-header">
                <h4>–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å #{{ index + 1 }}</h4>
                <button
                  @click="removeSpecialty(index)"
                  class="btn-icon danger"
                  title="–£–¥–∞–ª–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å"
                >
                  üóëÔ∏è
                </button>
              </div>

              <div class="specialty-form">
                <div class="form-grid compact">
                  <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ *</label>
                    <input
                      v-model="specialty.title"
                      type="text"
                      required
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑–Ω–æ—Ä–∞–±–æ—á–∏–π"
                      class="form-input"
                    >
                  </div>

                  <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç *</label>
                    <input
                      v-model="specialty.total_places"
                      type="number"
                      required
                      min="1"
                      max="100"
                      class="form-input"
                    >
                  </div>

                  <div class="form-group">
                    <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ –≤ –¥–µ–Ω—å (—Ä—É–±)</label>
                    <input
                      v-model="specialty.salary"
                      type="number"
                      placeholder="5000"
                      class="form-input"
                    >
                  </div>

                  <div class="form-group full-width">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</label>
                    <textarea
                      v-model="specialty.description"
                      rows="2"
                      placeholder="–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –∑–∞–¥–∞—á–∏..."
                      class="form-input"
                    ></textarea>
                  </div>

                  <div class="form-group full-width">
                    <label>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</label>
                    <textarea
                      v-model="specialty.requirements"
                      rows="2"
                      placeholder="–ù–∞–≤—ã–∫–∏, –æ–ø—ã—Ç, —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º–∞..."
                      class="form-input"
                    ></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-if="specialties.length === 0" class="empty-specialties">
            <div class="empty-icon">üë∑</div>
            <h4>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π</h4>
            <p>–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</p>
            <button @click="addSpecialty" class="btn btn-primary">
              ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å
            </button>
          </div>
        </div>
      </div>

      <div v-if="error" class="error-message">
        {{ error }}
      </div>

      <div class="modal-footer">
        <div class="footer-actions">
          <button
            v-if="activeTab === 'specialties'"
            @click="activeTab = 'enterprise'"
            class="btn btn-outline"
          >
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
          </button>

          <button
            v-if="activeTab === 'enterprise'"
            @click="validateEnterpriseAndProceed"
            class="btn btn-primary"
          >
            –î–∞–ª–µ–µ: –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ ‚Üí
          </button>

          <button
            v-if="activeTab === 'specialties' && specialties.length > 0"
            @click="createVakhtaWithSpecialties"
            :disabled="loading"
            class="btn btn-success"
          >
            <span v-if="loading" class="btn-spinner"></span>
            {{ loading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '‚úÖ –°–æ–∑–¥–∞—Ç—å –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ' }}
          </button>
        </div>

        <button
          v-if="activeTab === 'enterprise'"
          @click="closeModal"
          class="btn btn-outline"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
const authStore = useAuthStore()

const emit = defineEmits(['close', 'saved'])

const activeTab = ref('enterprise')
const loading = ref(false)
const error = ref('')

// –§–æ—Ä–º–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
const enterpriseForm = reactive({
  title: '',
  description: '',
  location: '',
  start_date: '',
  end_date: '',
  conditions: ''
})

// –°–ø–∏—Å–æ–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π
const specialties = ref<Array<{
  title: string
  description: string
  requirements: string
  total_places: number
  salary: number
}>>([])

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
const addSpecialty = () => {
  specialties.value.push({
    title: '',
    description: '',
    requirements: '',
    total_places: 10,
    salary: 5000
  })
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
const removeSpecialty = (index: number) => {
  specialties.value.splice(index, 1)
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º
const validateEnterpriseAndProceed = () => {
  if (!enterpriseForm.title.trim()) {
    error.value = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è'
    return
  }

  if (!enterpriseForm.location.trim()) {
    error.value = '–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
    return
  }

  if (!enterpriseForm.start_date || !enterpriseForm.end_date) {
    error.value = '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è'
    return
  }

  const startDate = new Date(enterpriseForm.start_date)
  const endDate = new Date(enterpriseForm.end_date)

  if (endDate <= startDate) {
    error.value = '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Å–ª–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'
    return
  }

  error.value = ''
  activeTab.value = 'specialties'
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—è–º–∏
const createVakhtaWithSpecialties = async () => {
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π
  for (const [index, specialty] of specialties.value.entries()) {
    if (!specialty.title.trim()) {
      error.value = `–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ #${index + 1}`
      return
    }

    if (specialty.total_places < 1) {
      error.value = `–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ "${specialty.title}"`
      return
    }
  }

  try {
    loading.value = true
    error.value = ''

    // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ (–≤–∞—Ö—Ç—É)
    const vakhtaResponse = await $fetch('http://localhost:3001/api/admin/vakhtas', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authStore.token}`
      },
      body: {
        title: enterpriseForm.title,
        description: enterpriseForm.description,
        location: enterpriseForm.location,
        start_date: enterpriseForm.start_date,
        end_date: enterpriseForm.end_date,
        conditions: enterpriseForm.conditions,
        total_places: specialties.value.reduce((sum, spec) => sum + spec.total_places, 0)
      }
    })

    console.log('Vakhta created:', vakhtaResponse)

    // –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
    const specialtyPromises = specialties.value.map(specialty =>
      $fetch('http://localhost:3001/api/specialties', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${authStore.token}`
        },
        body: {
          vakhta_id: vakhtaResponse.id,
          title: specialty.title,
          description: specialty.description,
          requirements: specialty.requirements,
          total_places: specialty.total_places,
          salary: specialty.salary || null
        }
      })
    )

    await Promise.all(specialtyPromises)
    console.log('All specialties created successfully')

    emit('saved')
    closeModal()

  } catch (err: any) {
    console.error('Error creating vakhta:', err)
    error.value = err.data?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è'
  } finally {
    loading.value = false
  }
}


const closeModal = () => {
  emit('close')
  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
  Object.assign(enterpriseForm, {
    title: '',
    description: '',
    location: '',
    start_date: '',
    end_date: '',
    conditions: ''
  })
  specialties.value = []
  activeTab.value = 'enterprise'
  error.value = ''
}

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
onMounted(() => {
  const tomorrow = new Date()
  tomorrow.setDate(tomorrow.getDate() + 1)
  enterpriseForm.start_date = tomorrow.toISOString().split('T')[0]

  const in30Days = new Date()
  in30Days.setDate(in30Days.getDate() + 30)
  enterpriseForm.end_date = in30Days.toISOString().split('T')[0]
})
</script>

<style scoped>
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal-content.large {
  max-width: 800px;
  max-height: 90vh;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 25px 30px;
  border-bottom: 1px solid #e9ecef;
}

.modal-header h2 {
  margin: 0;
  color: #333;
  font-size: 1.4rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6c757d;
  padding: 5px;
  border-radius: 4px;
}

.close-btn:hover {
  background: #f8f9fa;
  color: #333;
}

.modal-tabs {
  display: flex;
  border-bottom: 1px solid #e9ecef;
  padding: 0 30px;
}

.tab-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 15px 20px;
  border: none;
  background: none;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  color: #666;
  font-weight: 500;
  transition: all 0.3s;
}

.tab-button.active {
  color: #007bff;
  border-bottom-color: #007bff;
}

.tab-count {
  background: #e9ecef;
  color: #495057;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.8rem;
  font-weight: 500;
}

.tab-button.active .tab-count {
  background: #007bff;
  color: white;
}

.modal-body {
  padding: 30px;
  max-height: 400px;
  overflow-y: auto;
}

.form-section {
  margin-bottom: 30px;
}

.form-section h3 {
  margin: 0 0 15px 0;
  color: #333;
  font-size: 1.1rem;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.form-grid.compact {
  gap: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

.form-input {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-input:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

textarea.form-input {
  resize: vertical;
  min-height: 80px;
}

.specialties-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.specialties-header h3 {
  margin: 0;
  color: #333;
}

.specialties-list {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.specialty-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 20px;
  border-left: 4px solid #007bff;
}

.specialty-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.specialty-header h4 {
  margin: 0;
  color: #333;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  border-radius: 4px;
  transition: background 0.3s;
}

.btn-icon.danger:hover {
  background: #f8d7da;
}

.empty-specialties {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.7;
}

.empty-specialties h4 {
  margin: 0 0 10px 0;
  color: #333;
}

.empty-specialties p {
  margin: 0 0 20px 0;
}

.error-message {
  background: #f8d7da;
  color: #721c24;
  padding: 12px 15px;
  border-radius: 6px;
  border: 1px solid #f5c6cb;
  margin: 0 30px;
}

.modal-footer {
  padding: 20px 30px;
  border-top: 1px solid #e9ecef;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.footer-actions {
  display: flex;
  gap: 15px;
  align-items: center;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  font-size: 14px;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #0056b3;
  transform: translateY(-1px);
}

.btn-success {
  background: #28a745;
  color: white;
}

.btn-success:hover:not(:disabled) {
  background: #218838;
  transform: translateY(-1px);
}

.btn-outline {
  background: transparent;
  border: 1px solid #6c757d;
  color: #6c757d;
}

.btn-outline:hover {
  background: #6c757d;
  color: white;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .modal-content.large {
    margin: 10px;
  }

  .modal-body {
    padding: 20px;
    max-height: 300px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .specialties-header {
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }

  .modal-footer {
    flex-direction: column;
    gap: 15px;
    align-items: stretch;
  }

  .footer-actions {
    flex-direction: column;
  }
}
</style>